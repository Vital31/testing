# Архитектура IoT системы

## 🏗️ Общая архитектура

Система построена на принципах микросервисной архитектуры с использованием современных технологий для обеспечения высокой производительности, масштабируемости и отказоустойчивости.

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Browser  │    │   Mobile App   │    │   IoT Devices  │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │        Nginx (80)         │
                    │   Load Balancer + Cache   │
                    └─────────────┬─────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │    API Gateway (8000)     │
                    │   FastAPI + Prometheus    │
                    └─────────────┬─────────────┘
                                 │
    ┌────────────────────────────┼────────────────────────────┐
    │                            │                            │
┌───▼─────┐              ┌───────▼──────┐              ┌─────▼─────┐
│ Device  │              │  Analytics  │              │   User    │
│Service  │              │   Service   │              │ Service   │
│ (5000)  │              │   (5000)    │              │  (5000)   │
└────┬────┘              └──────┬───────┘              └─────┬─────┘
     │                         │                            │
     └─────────────────────────┼────────────────────────────┘
                               │
                    ┌──────────▼──────────┐
                    │   Audit Service     │
                    │      (5000)         │
                    └──────────┬──────────┘
                               │
    ┌──────────────────────────┼──────────────────────────┐
    │                          │                          │
┌───▼─────┐            ┌───────▼──────┐            ┌─────▼─────┐
│Redis    │            │ PostgreSQL  │            │ RabbitMQ  │
│(6379)   │            │Master(5432) │            │ (5672)    │
│Cache    │            └──────┬───────┘            │Queues     │
└─────────┘                   │                    └───────────┘
                              │
                    ┌─────────▼─────────┐
                    │ PostgreSQL Slave  │
                    │     (5433)        │
                    └───────────────────┘
```

## 🔧 Компоненты системы

### 1. Frontend (Веб-интерфейс)
- **Технология**: HTML5, CSS3, JavaScript, Bootstrap 5
- **Функции**: 
  - Дашборд с метриками
  - Управление устройствами
  - Просмотр аналитики
  - Мониторинг системы
  - Настройки и конфигурация

### 2. Nginx (Балансировщик нагрузки)
- **Порт**: 80
- **Функции**:
  - Балансировка нагрузки между сервисами
  - Кэширование статического контента
  - Rate limiting
  - SSL termination
  - Gzip сжатие

### 3. API Gateway (FastAPI)
- **Порт**: 8000
- **Функции**:
  - Маршрутизация запросов к микросервисам
  - Аутентификация и авторизация
  - Кэширование ответов
  - Логирование запросов
  - Метрики Prometheus

### 4. Микросервисы

#### Device Service (Flask)
- **Порт**: 5000
- **Функции**:
  - CRUD операции с устройствами
  - Прием данных от IoT устройств
  - Асинхронная обработка данных
  - Мониторинг состояния устройств

#### Analytics Service (Flask)
- **Порт**: 5000
- **Функции**:
  - Аналитика в реальном времени
  - Обнаружение аномалий
  - Историческая аналитика
  - Агрегация данных

#### User Service (Flask)
- **Порт**: 5000
- **Функции**:
  - Управление пользователями
  - Аутентификация
  - Роли и права доступа

#### Audit Service (Flask)
- **Порт**: 5000
- **Функции**:
  - Логирование всех событий
  - Event Sourcing
  - Восстановление состояния

### 5. База данных

#### PostgreSQL Master
- **Порт**: 5432
- **Функции**:
  - Основная база данных
  - Запись данных
  - Репликация на slave

#### PostgreSQL Slave
- **Порт**: 5433
- **Функции**:
  - Реплика базы данных
  - Чтение данных
  - Отказоустойчивость

### 6. Кэширование

#### Redis
- **Порт**: 6379
- **Функции**:
  - Кэширование ответов API
  - Сессии пользователей
  - Временные данные
  - Очереди задач

### 7. Очереди сообщений

#### RabbitMQ
- **Порт**: 5672 (AMQP), 15672 (Management)
- **Функции**:
  - Асинхронная обработка данных
  - Event-driven архитектура
  - Надежная доставка сообщений

### 8. Мониторинг

#### Prometheus
- **Порт**: 9090
- **Функции**:
  - Сбор метрик
  - Алерты
  - Мониторинг производительности

#### Grafana
- **Порт**: 3000
- **Функции**:
  - Визуализация метрик
  - Дашборды
  - Аналитика

### 9. Хранилище

#### MinIO
- **Порт**: 9000 (API), 9001 (Console)
- **Функции**:
  - S3-совместимое хранилище
  - Резервные копии
  - Статические файлы

## 🔄 Потоки данных

### 1. Регистрация устройства
```
IoT Device → Nginx → API Gateway → Device Service → PostgreSQL Master
                                                      ↓
                                              PostgreSQL Slave
```

### 2. Отправка данных
```
IoT Device → Nginx → API Gateway → Device Service → RabbitMQ → Analytics Service
                                                      ↓
                                              PostgreSQL Master
                                                      ↓
                                              PostgreSQL Slave
```

### 3. Получение аналитики
```
Client → Nginx → API Gateway → Analytics Service → Redis (кэш)
                                                    ↓
                                            PostgreSQL Slave
```

### 4. Аудит событий
```
Any Service → Audit Service → RabbitMQ → PostgreSQL Master
                                        ↓
                                  PostgreSQL Slave
```

## 📊 Масштабирование

### Горизонтальное масштабирование
- **API Gateway**: Может быть масштабирован до N экземпляров
- **Device Service**: Может быть масштабирован до N экземпляров
- **Analytics Service**: Может быть масштабирован до N экземпляров
- **User Service**: Может быть масштабирован до N экземпляров

### Вертикальное масштабирование
- **PostgreSQL**: Увеличение ресурсов сервера
- **Redis**: Увеличение памяти
- **RabbitMQ**: Увеличение ресурсов

### Шардинг
- **PostgreSQL**: Партиционирование по дате
- **Redis**: Кластеризация
- **MinIO**: Распределенное хранение

## 🛡️ Безопасность

### Аутентификация
- JWT токены
- OAuth 2.0 (готово к интеграции)
- API ключи

### Авторизация
- RBAC (Role-Based Access Control)
- Права доступа на уровне ресурсов
- Аудит действий

### Шифрование
- HTTPS/TLS
- Шифрование данных в покое
- Шифрование данных в движении

### Защита от атак
- Rate limiting
- Валидация входных данных
- SQL injection protection
- XSS protection

## 🔍 Мониторинг и логирование

### Метрики
- **Системные**: CPU, RAM, Disk, Network
- **Прикладные**: Request rate, Response time, Error rate
- **Бизнес**: Number of devices, Data points, Users

### Логирование
- **Структурированные логи**: JSON формат
- **Централизованное логирование**: ELK Stack (готово к интеграции)
- **Аудит**: Все действия пользователей

### Алерты
- **Критические**: Сбой сервиса, недоступность БД
- **Предупреждения**: Высокая нагрузка, мало места
- **Информационные**: Новые устройства, аномалии

## 🔄 Отказоустойчивость

### Репликация
- **PostgreSQL**: Master-Slave репликация
- **Redis**: Sentinel (готово к интеграции)
- **RabbitMQ**: Кластер (готово к интеграции)

### Резервное копирование
- **Автоматические бэкапы**: Ежечасно
- **Point-in-Time Recovery**: Поддержка
- **Географическое распределение**: MinIO

### Восстановление
- **Автоматическое восстановление**: Health checks
- **Ручное восстановление**: Скрипты восстановления
- **Тестирование восстановления**: Автоматизированные тесты

## 🚀 Производительность

### Оптимизации
- **Кэширование**: Redis для часто запрашиваемых данных
- **Индексы**: Оптимизированные индексы в PostgreSQL
- **Партиционирование**: По дате для больших таблиц
- **Сжатие**: Gzip для HTTP, WAL compression

### Бенчмарки
- **API Gateway**: 10,000 RPS
- **Device Service**: 5,000 устройств/сек
- **Analytics Service**: 1,000,000 точек данных/сек
- **PostgreSQL**: 100,000 запросов/сек

## 📈 Планы развития

### Краткосрочные (1-3 месяца)
- Добавление аутентификации OAuth 2.0
- Интеграция с ELK Stack
- Добавление WebSocket для real-time данных
- Улучшение дашбордов Grafana

### Среднесрочные (3-6 месяцев)
- Миграция на Kubernetes
- Добавление GraphQL API
- Интеграция с внешними IoT платформами
- Машинное обучение для предсказания

### Долгосрочные (6+ месяцев)
- Географическое распределение
- Edge computing интеграция
- Blockchain для аудита
- AI/ML для автоматизации

## 🎯 Заключение

Данная архитектура обеспечивает:
- **Высокую производительность** через кэширование и оптимизацию
- **Масштабируемость** через микросервисы и горизонтальное масштабирование
- **Отказоустойчивость** через репликацию и мониторинг
- **Безопасность** через многоуровневую защиту
- **Гибкость** через модульную архитектуру

Система готова к продакшн использованию и может быть легко адаптирована под конкретные требования проекта. 